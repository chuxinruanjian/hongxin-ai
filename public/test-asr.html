<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¯­éŸ³è¯†åˆ«æµ‹è¯• - HongXinOS</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 40px;
      max-width: 600px;
      width: 100%;
    }

    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .status {
      text-align: center;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .status.disconnected {
      background: #fee;
      color: #c33;
    }

    .status.connected {
      background: #efe;
      color: #3c3;
    }

    .status.recording {
      background: #ffeaa7;
      color: #d63031;
      animation: pulse 1.5s ease-in-out infinite;
    }

    .status.processing {
      background: #e3f2fd;
      color: #1976d2;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    button {
      flex: 1;
      padding: 15px 30px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      color: white;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    button:not(:disabled):hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    button:not(:disabled):active {
      transform: translateY(0);
    }

    #startBtn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    #stopBtn {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    #clearBtn {
      background: #95a5a6;
      flex: 0 0 auto;
      padding: 15px 20px;
    }

    .result-container {
      margin-top: 20px;
    }

    .result-label {
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .result-box {
      background: #f8f9fa;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      padding: 20px;
      min-height: 100px;
      max-height: 300px;
      overflow-y: auto;
      font-size: 18px;
      line-height: 1.6;
      color: #333;
      margin-bottom: 15px;
      transition: all 0.3s ease;
      word-wrap: break-word;
    }

    .result-box.has-content {
      background: #e3f2fd;
      border-color: #2196f3;
    }

    .result-box.empty {
      color: #999;
      font-style: italic;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .result-box.error {
      background: #ffebee;
      border-color: #f44336;
      color: #c62828;
    }

    .logs {
      background: #263238;
      color: #aed581;
      border-radius: 10px;
      padding: 15px;
      max-height: 200px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.5;
    }

    .logs::-webkit-scrollbar {
      width: 8px;
    }

    .logs::-webkit-scrollbar-track {
      background: #37474f;
      border-radius: 10px;
    }

    .logs::-webkit-scrollbar-thumb {
      background: #546e7a;
      border-radius: 10px;
    }

    .log-entry {
      margin-bottom: 5px;
    }

    .log-time {
      color: #81c784;
      margin-right: 5px;
    }

    .log-type {
      font-weight: bold;
      margin-right: 5px;
    }

    .log-type.info {
      color: #64b5f6;
    }

    .log-type.success {
      color: #81c784;
    }

    .log-type.error {
      color: #e57373;
    }

    .config {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .config-row {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .config-row:last-child {
      margin-bottom: 0;
    }

    .config-label {
      flex: 0 0 100px;
      font-weight: 600;
      color: #666;
      font-size: 14px;
    }

    .config-value {
      flex: 1;
      font-size: 12px;
    }

    .info-box {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 12px;
      margin-bottom: 20px;
      border-radius: 5px;
      font-size: 13px;
      color: #1565c0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¤ çŸ­è¯­éŸ³è¯†åˆ«æµ‹è¯•</h1>
    <p class="subtitle">HongXinOS - è¯­éŸ³è¯†åˆ«</p>

    <div id="status" class="status disconnected">
      âš« æœªè¿æ¥
    </div>

    <div class="info-box">
      <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
      1. ç‚¹å‡»"å¼€å§‹å½•éŸ³"å¼€å§‹æ”¶é›†éŸ³é¢‘æ•°æ®<br>
      2. è¯´è¯åç‚¹å‡»"åœæ­¢å½•éŸ³"è¿›è¡Œè¯†åˆ«<br>
      3. è¯†åˆ«ç»“æœä¼šåœ¨åœæ­¢åæ˜¾ç¤º
    </div>

    <div class="config">
      <div class="config-row">
        <div class="config-label">æœåŠ¡å™¨åœ°å€:</div>
        <div class="config-value" style="font-family: monospace; color: #666;">
          ws://localhost:9650/speech
        </div>
      </div>
      <div class="config-row">
        <div class="config-label">éº¦å…‹é£æƒé™:</div>
        <div class="config-value">
          <span id="permissionStatus" style="color: #666;">æ£€æŸ¥ä¸­...</span>
          <button id="checkPermissionBtn" style="margin-left: 10px; padding: 4px 8px; font-size: 11px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer;">æ£€æŸ¥æƒé™</button>
        </div>
      </div>
    </div>

    <div class="controls">
      <button id="startBtn">ğŸ™ï¸ å¼€å§‹å½•éŸ³</button>
      <button id="stopBtn" disabled>â¹ï¸ åœæ­¢å½•éŸ³</button>
      <button id="clearBtn">ğŸ—‘ï¸ æ¸…ç©º</button>
    </div>

    <div class="result-container">
      <div class="result-label">è¯†åˆ«ç»“æœ</div>
      <div id="result" class="result-box empty">ç­‰å¾…è¯†åˆ«ç»“æœ...</div>

      <div class="result-label">æ—¥å¿—</div>
      <div id="logs" class="logs"></div>
    </div>
  </div>

  <script>
    let ws;
    let audioContext;
    let processor;
    let mediaStream;
    let audioBytesSent = 0;

    const statusEl = document.getElementById('status');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const clearBtn = document.getElementById('clearBtn');
    const resultEl = document.getElementById('result');
    const logsEl = document.getElementById('logs');
    const permissionStatusEl = document.getElementById('permissionStatus');
    const checkPermissionBtn = document.getElementById('checkPermissionBtn');

    function log(message, type = 'info') {
      const time = new Date().toLocaleTimeString('zh-CN', { hour12: false });
      const logEntry = document.createElement('div');
      logEntry.className = 'log-entry';
      logEntry.innerHTML = `
        <span class="log-time">[${time}]</span>
        <span class="log-type ${type}">[${type.toUpperCase()}]</span>
        ${message}
      `;
      logsEl.insertBefore(logEntry, logsEl.firstChild);

      // é™åˆ¶æ—¥å¿—æ¡æ•°
      while (logsEl.children.length > 50) {
        logsEl.removeChild(logsEl.lastChild);
      }
    }

    function updateStatus(text, className) {
      statusEl.textContent = text;
      statusEl.className = `status ${className}`;
    }

    startBtn.onclick = async () => {
      try {
        // 0. æ¸…ç©ºä¹‹å‰çš„ç»“æœ
        resultEl.textContent = 'ç­‰å¾…è¯†åˆ«ç»“æœ...';
        resultEl.className = 'result-box empty';
        audioBytesSent = 0;
        log('å·²æ¸…ç©ºä¹‹å‰çš„ç»“æœ', 'info');

        // 0.5. å…ˆæ£€æŸ¥å¹¶è¯·æ±‚éº¦å…‹é£æƒé™
        updateStatus('ğŸ¤ æ£€æŸ¥éº¦å…‹é£æƒé™...', 'disconnected');

        let permissionStatus = 'prompt';
        if (navigator.permissions) {
          try {
            const result = await navigator.permissions.query({ name: 'microphone' });
            permissionStatus = result.state;
            log(`å½“å‰éº¦å…‹é£æƒé™çŠ¶æ€: ${permissionStatus}`, 'info');

            if (permissionStatus === 'denied') {
              const errorMsg = 'éº¦å…‹é£æƒé™å·²è¢«æ‹’ç»ã€‚\n\nè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤é‡ç½®æƒé™ï¼š\n1. ç‚¹å‡»åœ°å€æ å·¦ä¾§çš„é”å›¾æ ‡\n2. æ‰¾åˆ°"éº¦å…‹é£"é€‰é¡¹\n3. é€‰æ‹©"å…è®¸"æˆ–"è¯¢é—®"\n4. åˆ·æ–°é¡µé¢åé‡è¯•';
              log(`âŒ ${errorMsg}`, 'error');
              updateStatus('âŒ éº¦å…‹é£æƒé™è¢«æ‹’ç»', 'disconnected');
              alert(errorMsg);
              return;
            }
          } catch (e) {
            log('æ— æ³•æŸ¥è¯¢æƒé™çŠ¶æ€ï¼Œç›´æ¥è¯·æ±‚æƒé™', 'info');
          }
        }

        // è¯·æ±‚éº¦å…‹é£æƒé™
        updateStatus('ğŸ¤ è¯·æ±‚éº¦å…‹é£æƒé™...', 'disconnected');
        log('æ­£åœ¨è¯·æ±‚éº¦å…‹é£æƒé™...', 'info');

        try {
          const testStream = await navigator.mediaDevices.getUserMedia({
            audio: {
              sampleRate: 16000,
              channelCount: 1,
              echoCancellation: true,
              noiseSuppression: true,
              autoGainControl: true
            }
          });
          testStream.getTracks().forEach(track => track.stop());

          if (permissionStatus === 'prompt') {
            log('âœ… éº¦å…‹é£æƒé™å·²è·å–ï¼ˆå·²å¼¹å‡ºæƒé™è¯·æ±‚å¯¹è¯æ¡†ï¼‰', 'success');
          } else {
            log('âœ… éº¦å…‹é£æƒé™å·²è·å–ï¼ˆä½¿ç”¨å·²ä¿å­˜çš„æƒé™ï¼‰', 'success');
          }
        } catch (error) {
          const errorMsg = error.name === 'NotAllowedError'
            ? 'éº¦å…‹é£æƒé™è¢«æ‹’ç»ã€‚\n\nè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤é‡ç½®æƒé™ï¼š\n1. ç‚¹å‡»åœ°å€æ å·¦ä¾§çš„é”å›¾æ ‡\n2. æ‰¾åˆ°"éº¦å…‹é£"é€‰é¡¹\n3. é€‰æ‹©"å…è®¸"æˆ–"è¯¢é—®"\n4. åˆ·æ–°é¡µé¢åé‡è¯•'
            : error.name === 'NotFoundError'
            ? 'æœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡ï¼Œè¯·æ£€æŸ¥è®¾å¤‡è¿æ¥'
            : `æ— æ³•è®¿é—®éº¦å…‹é£: ${error.message}`;

          log(`âŒ ${errorMsg}`, 'error');
          updateStatus('âŒ éº¦å…‹é£æƒé™å¤±è´¥', 'disconnected');
          alert(errorMsg);
          return;
        }

        // 1. è¿æ¥ WebSocket
        updateStatus('ğŸ”„ æ­£åœ¨è¿æ¥...', 'disconnected');
        log('æ­£åœ¨è¿æ¥ WebSocket...', 'info');

        ws = new WebSocket('ws://localhost:9650/speech');
        // ws = new WebSocket('wss://ai.chuxinruanjian.com/speech');

        ws.onopen = () => {
          updateStatus('âœ… å·²è¿æ¥', 'connected');
          log('WebSocket è¿æ¥æˆåŠŸ', 'success');

          // 2. å¯åŠ¨è¯­éŸ³è¯†åˆ«
          log('å‘é€ start æŒ‡ä»¤', 'info');
          ws.send(JSON.stringify({
            type: 'start',
            num: 1
          }));
        };

        ws.onmessage = (event) => {
          const message = JSON.parse(event.data);
          log(`æ”¶åˆ°æ¶ˆæ¯: ${message.type}`, 'info');

          if (message.type === 'started') {
            updateStatus('ğŸ”´ æ­£åœ¨å½•éŸ³...', 'recording');
            log('è¯­éŸ³è¯†åˆ«å·²å¯åŠ¨ï¼Œå¼€å§‹å½•éŸ³', 'success');
            startRecording();
          } else if (message.type === 'stopped') {
            updateStatus('âœ… å·²åœæ­¢', 'connected');
            log('è¯­éŸ³è¯†åˆ«å·²åœæ­¢', 'info');

            // æ˜¾ç¤ºè¯†åˆ«ç»“æœ
            if (message.hasResult && message.result) {
              resultEl.textContent = message.result.fullText || message.result.text;
              resultEl.className = 'result-box has-content';
              log(`âœ… è¯†åˆ«æˆåŠŸ: ${message.result.fullText || message.result.text}`, 'success');
            } else {
              resultEl.textContent = message.error || 'è¯†åˆ«å¤±è´¥æˆ–æ— ç»“æœ';
              resultEl.className = 'result-box error';
              log(`âŒ è¯†åˆ«å¤±è´¥: ${message.error || 'æ— ç»“æœ'}`, 'error');
            }

            stopRecording();
          } else if (message.type === 'ERROR') {
            updateStatus('âŒ é”™è¯¯', 'disconnected');
            log(`é”™è¯¯: ${message.message}`, 'error');
            resultEl.textContent = `é”™è¯¯: ${message.message}`;
            resultEl.className = 'result-box error';
            alert(`é”™è¯¯: ${message.message}`);
          } else if (message.type === 'pong') {
            log('æ”¶åˆ°å¿ƒè·³å“åº”', 'info');
          }
        };

        ws.onerror = (error) => {
          updateStatus('âŒ è¿æ¥é”™è¯¯', 'disconnected');
          log('WebSocket é”™è¯¯', 'error');
          console.error('WebSocket error:', error);
        };

        ws.onclose = () => {
          updateStatus('âš« æœªè¿æ¥', 'disconnected');
          log('WebSocket è¿æ¥å·²å…³é—­', 'info');
          stopRecording();
        };

        startBtn.disabled = true;
        stopBtn.disabled = false;

      } catch (error) {
        log(`é”™è¯¯: ${error.message}`, 'error');
        console.error('Error:', error);
      }
    };

    stopBtn.onclick = () => {
      log('åœæ­¢å½•éŸ³...', 'info');
      updateStatus('â³ æ­£åœ¨è¯†åˆ«...', 'processing');

      // åœæ­¢å½•éŸ³
      stopRecording();

      // åœæ­¢è¯†åˆ«
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'stop' }));
      } else {
        updateStatus('âŒ è¿æ¥å·²æ–­å¼€', 'disconnected');
        log('WebSocket è¿æ¥å·²æ–­å¼€ï¼Œæ— æ³•å‘é€åœæ­¢æŒ‡ä»¤', 'error');
      }
    };

    clearBtn.onclick = () => {
      resultEl.textContent = 'ç­‰å¾…è¯†åˆ«ç»“æœ...';
      resultEl.className = 'result-box empty';
      log('å·²æ¸…ç©ºè¯†åˆ«ç»“æœ', 'info');
    };

    async function startRecording() {
      try {
        log('è·å–éº¦å…‹é£éŸ³é¢‘æµ...', 'info');
        mediaStream = await navigator.mediaDevices.getUserMedia({
          audio: {
            sampleRate: 16000,
            channelCount: 1,
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true
          }
        });

        log('âœ… éº¦å…‹é£éŸ³é¢‘æµå·²è·å–', 'success');

        // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
        audioContext = new (window.AudioContext || window.webkitAudioContext)({
          sampleRate: 16000
        });

        const source = audioContext.createMediaStreamSource(mediaStream);
        processor = audioContext.createScriptProcessor(4096, 1, 1);

        source.connect(processor);
        processor.connect(audioContext.destination);

        processor.onaudioprocess = (e) => {
          if (ws && ws.readyState === WebSocket.OPEN) {
            const inputData = e.inputBuffer.getChannelData(0);

            // è½¬æ¢ä¸º 16bit PCM
            const pcmData = new Int16Array(inputData.length);
            for (let i = 0; i < inputData.length; i++) {
              pcmData[i] = Math.max(-32768, Math.min(32767, inputData[i] * 32768));
            }

            // å‘é€éŸ³é¢‘æ•°æ®
            ws.send(pcmData.buffer);
            audioBytesSent += pcmData.buffer.byteLength;

            // æ¯ 1MB è®°å½•ä¸€æ¬¡
            if (audioBytesSent > 0 && audioBytesSent % (1024 * 1024) < 8192) {
              log(`å·²å‘é€éŸ³é¢‘: ${(audioBytesSent / 1024 / 1024).toFixed(2)} MB`, 'info');
            }
          }
        };

        log('å½•éŸ³å·²å¼€å§‹', 'success');

      } catch (error) {
        const errorMsg = error.name === 'NotAllowedError'
          ? 'éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼Œè¯·åˆ·æ–°é¡µé¢é‡æ–°æˆæƒ'
          : error.name === 'NotFoundError'
          ? 'æœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡'
          : `å½•éŸ³å¤±è´¥: ${error.message}`;

        log(`âŒ ${errorMsg}`, 'error');
        console.error('Recording error:', error);
        updateStatus('âŒ å½•éŸ³å¤±è´¥', 'disconnected');
        alert(errorMsg);

        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'stop' }));
        }
      }
    }

    function stopRecording() {
      if (processor) {
        processor.disconnect();
        processor = null;
      }

      if (audioContext) {
        audioContext.close();
        audioContext = null;
      }

      if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
        mediaStream = null;
      }

      log('å½•éŸ³å·²åœæ­¢', 'info');
      startBtn.disabled = false;
      stopBtn.disabled = true;
    }

    // æ£€æŸ¥éº¦å…‹é£æƒé™çŠ¶æ€
    async function checkPermissionStatus() {
      if (!navigator.permissions) {
        permissionStatusEl.textContent = 'ä¸æ”¯æŒæƒé™æŸ¥è¯¢';
        permissionStatusEl.style.color = '#999';
        return;
      }

      try {
        const result = await navigator.permissions.query({ name: 'microphone' });
        const status = result.state;

        if (status === 'granted') {
          permissionStatusEl.textContent = 'âœ… å·²å…è®¸';
          permissionStatusEl.style.color = '#3c3';
        } else if (status === 'denied') {
          permissionStatusEl.textContent = 'âŒ å·²æ‹’ç»';
          permissionStatusEl.style.color = '#c33';
        } else {
          permissionStatusEl.textContent = 'â“ æœªè®¾ç½®ï¼ˆç‚¹å‡»å¼€å§‹å½•éŸ³æ—¶ä¼šå¼¹å‡ºè¯·æ±‚ï¼‰';
          permissionStatusEl.style.color = '#f90';
        }

        result.onchange = () => {
          checkPermissionStatus();
        };
      } catch (error) {
        permissionStatusEl.textContent = 'æ— æ³•æŸ¥è¯¢æƒé™çŠ¶æ€';
        permissionStatusEl.style.color = '#999';
      }
    }

    checkPermissionBtn.onclick = () => {
      checkPermissionStatus();
      log('é‡æ–°æ£€æŸ¥éº¦å…‹é£æƒé™çŠ¶æ€', 'info');
    };

    // é¡µé¢åˆå§‹åŒ–
    log('é¡µé¢å·²åŠ è½½ï¼Œå‡†å¤‡å°±ç»ª', 'success');
    log('è¯·ç‚¹å‡»"å¼€å§‹å½•éŸ³"æŒ‰é’®å¼€å§‹æµ‹è¯•', 'info');
    checkPermissionStatus();
  </script>
</body>
</html>
